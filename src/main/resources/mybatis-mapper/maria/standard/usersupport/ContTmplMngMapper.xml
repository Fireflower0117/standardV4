<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.opennote.standard.mapper.usersupport.contTmplMngMapper">
	
	<sql id="Where">
		<if test="schEtc00 !=null and schEtc00 !=''">
			AND TMPL_CL = #{schEtc00}
		</if>
		<if test="schEtc01 !=null and schEtc01 !=''">
			AND TMPL_TP = #{schEtc01}
		</if>
		<if test="schEtc02 !=null and schEtc02 !=''">
			AND TMPL_TP = #{schEtc02}
		</if>
		
		<if test="schEtc03 !=null and schEtc03 !=''">
			AND TMPL_CL = #{schEtc03}
			<if test="schEtc04 !=null and schEtc04 !=''">
				AND TMPL_TP = #{schEtc04}
			</if>
		</if>
		<if test="searchKeyword !=null and searchKeyword !=''">
			<if test="searchCondition ==null or searchCondition == ''">
				AND (UPPER(TMPL_EXPL) LIKE CONCAT('%',UPPER(#{searchKeyword}),'%')
				 OR UPPER(EDITR_CONT) LIKE CONCAT('%',UPPER(#{searchKeyword}),'%'))
			</if>
			<if test="searchCondition !=null and searchCondition !='' and searchCondition==1">
				AND UPPER(TMPL_EXPL) LIKE CONCAT('%',UPPER(#{searchKeyword}),'%')
			</if>
			<if test="searchCondition !=null and searchCondition !='' and searchCondition==2">
				AND UPPER(EDITR_CONT) LIKE CONCAT('%',UPPER(#{searchKeyword}),'%')
			</if>
		</if>
	</sql>
	
	<!-- 컨텐츠 건수 조회-->
	<select id="selectCount" parameterType="bltnbVO" resultType="contTmplVO">
		/* com.opennote.standard.mapper.usersupport.contTmplMngMapper.selectCount */
		SELECT COUNT(1) contTmplCount
		  FROM T_CONT_TMPL_MNG
	   <where>
		 <include refid="Where"/>
		   AND USE_YN = 'Y'
	   </where>
	</select>
	
	<!-- 컨텐츠 목록 조회-->
	<select id="selectList" parameterType="contTmplVO" resultType="contTmplVO">
		/* com.opennote.standard.mapper.usersupport.contTmplMngMapper.selectList */
		SELECT 
			   TMPL_SERNO								tmplSerno
			 , FNC_CODE_NM(TMPL_CL)						tmplCl
			 , FNC_CODE_NM(TMPL_TP)						tmplTp
			 , TMPL_EXPL								tmplExpl
			 , PRVW_FILE_SERNO							prvwFileSerno
			 , DATE_FORMAT(REG_DT, '%Y.%m.%d')			regDt
		  FROM T_CONT_TMPL_MNG
		<where>
		   <include refid="Where"/>
		   AND USE_YN = 'Y'
		</where>
	  ORDER BY TMPL_SERNO DESC 
		 LIMIT #{firstRecordIndex} , #{recordCountPerPage}	
	</select>
	
	<!-- 컨텐츠 목록 조회-->
	<select id="selectExcelList" parameterType="contTmplVO" resultType="contTmplVO">
		/* com.opennote.standard.mapper.usersupport.contTmplMngMapper.selectExcelList */
		SELECT 
			   FNC_CODE_NM(TMPL_CL)						tmplCl
			 , FNC_CODE_NM(TMPL_TP)						tmplTp
			 , TMPL_EXPL								tmplExpl
			 , EDITR_CONT								editrCont
			 , FNC_USER_NM(REGR_SERNO)					regrSerno
			 , DATE_FORMAT(REG_DT, '%Y.%m.%d')			regDt
			 , FNC_USER_NM(UPDR_SERNO)					updrSerno
			 , DATE_FORMAT(UPD_DT, '%Y.%m.%d')			updDt
		  FROM T_CONT_TMPL_MNG
		<where>
		   <include refid="Where"/>
		   AND USE_YN = 'Y'
		</where>
	  ORDER BY TMPL_SERNO DESC 
	</select>
	
	<!-- 컨텐츠 상세 조회-->
	<select id="selectContents" parameterType="contTmplVO" resultType="contTmplVO">
		/* com.opennote.standard.mapper.usersupport.contTmplMngMapper.selectContents */
		SELECT 
		       TMPL_SERNO								tmplSerno
			 , CONCAT('TMPL_', LPAD(TMPL_SERNO,'5',0))  tmplCd
			 , TMPL_CL									tmplCl
			 , TMPL_TP									tmplTp
			 , TMPL_EXPL								tmplExpl
			 , EDITR_CONT								editrCont
			 , TMPL_FILE_SERNO							tmplFileSerno
			 , REGR_SERNO								regrSerno
			 , DATE_FORMAT(REG_DT, '%Y.%m.%d')			regDt
		  FROM T_CONT_TMPL_MNG
		 <where>
		 	   TMPL_SERNO = #{tmplSerno}
		   AND USE_YN = 'Y'
		 </where>
	</select>
	
	<!-- 컨텐츠 등록 -->
	<insert id="insertContents" parameterType="contTmplVO" useGeneratedKeys="true" keyProperty="tmplSerno" keyColumn="TMPL_SERNO">
		/* com.opennote.standard.mapper.usersupport.contTmplMngMapper.insertContents */
		INSERT INTO T_CONT_TMPL_MNG (
			    TMPL_EXPL
			  , EDITR_CONT
			  , TMPL_CL
			  , TMPL_TP
			  , TMPL_FILE_SERNO
			  , PRVW_FILE_SERNO
			  , REGR_SERNO
			  , REG_DT
			)
			VALUES (
			    #{tmplExpl}
			  , #{editrCont}
			  , #{tmplCl}
			  , #{tmplTp}	
			  , #{tmplFileSerno}
			  , #{prvwFileSerno}
			  , #{loginSerno}
			  , NOW()
			)
	</insert>
	
	<!-- 컨텐츠 수정 -->
	<update id="updateContents" parameterType="contTmplVO">
		/* com.opennote.standard.mapper.usersupport.contTmplMngMapper.updateContents */
		UPDATE T_CONT_TMPL_MNG
		   SET TMPL_EXPL 		= #{tmplExpl}
			 , EDITR_CONT		= #{editrCont}
			 , TMPL_FILE_SERNO	= #{tmplFileSerno}
			 , PRVW_FILE_SERNO	= #{prvwFileSerno}
			 , TMPL_CL			= #{tmplCl}
			 , TMPL_TP			= #{tmplTp}
			 , UPDR_SERNO		= #{loginSerno}
			 , UPD_DT			= NOW()
		 <where>
		 	  TMPL_SERNO = #{tmplSerno}
		 </where>
	</update>
	
	<!-- 컨텐츠 삭제 -->
	<update id="deleteContents" parameterType="contTmplVO">
		/* com.opennote.standard.mapper.usersupport.contTmplMngMapper.deleteContents */
		UPDATE T_CONT_TMPL_MNG
		   SET USE_YN 	= 'N'
		<where>
			   TMPL_SERNO = #{tmplSerno}
	  	</where>
	</update>
	
	<!-- 컨텐츠 등록시 tmplSerno replace -->
	<update id="editrContReplace" parameterType="contTmplVO">
		/* com.opennote.standard.mapper.usersupport.contTmplMngMapper.editrContReplace */
		UPDATE T_CONT_TMPL_MNG
		   SET EDITR_CONT = REPLACE(EDITR_CONT, 'TMPL_TEMP', CONCAT('TMPL_', LPAD(#{tmplSerno},'5',0)))
		<where> 
			   TMPL_SERNO = #{tmplSerno}
		   AND USE_YN = 'Y'
		</where>
	</update>
	
	<!-- 컨텐츠 popup 건수 조회-->
	<select id="popSelectCount" parameterType="contTmplVO" resultType="contTmplVO">
		/* com.opennote.standard.mapper.usersupport.contTmplMngMapper.popSelectCount */
		SELECT COUNT(1) tmplCnt
		  FROM T_CONT_TMPL_MNG
	   <where>
	     <if test="tabDivn !=null and tabDivn !=''">
			 TMPL_CL = #{tabDivn}
		 </if>
		 <include refid="Where"/>
		   AND USE_YN = 'Y'
	   </where>
	</select>
	
	<!-- 컨텐츠 popup 목록 조회-->
	<select id="popSelectList" parameterType="contTmplVO" resultType="contTmplVO">
		/* com.opennote.standard.mapper.usersupport.contTmplMngMapper.popSelectList */
		SELECT 
			   A.TMPL_SERNO								tmplSerno
			 , FNC_CODE_NM(A.TMPL_CL)					tmplCl
			 , FNC_CODE_NM(A.TMPL_TP)					tmplTp
			 , A.TMPL_EXPL								tmplExpl
			 , A.EDITR_CONT								editrCont
			 , A.PRVW_FILE_SERNO						prvwFileSerno
			 , DATE_FORMAT(A.REG_DT, '%Y.%m.%d')		regDt
			 , B.FVRT_SERNO								fvrtSerno  
		  FROM T_CONT_TMPL_MNG A
	 LEFT JOIN T_CONT_TMPL_FVRT_MNG B
		    ON A.TMPL_SERNO = B.TMPL_SERNO
   		   AND B.USE_YN = 'Y'
		<where>
		   <if test="tabDivn !=null and tabDivn !=''">
			 TMPL_CL = #{tabDivn}
		   </if>
		   <include refid="Where"/>
		   AND A.USE_YN = 'Y'
		</where>
	  ORDER BY A.TMPL_SERNO DESC 
		 LIMIT #{firstRecordIndex} , #{recordCountPerPage}	
	</select>
	
	<!-- 컨텐츠 즐겨찾기 목록 조회-->
	<select id="fvrtSelectList" parameterType="contTmplVO" resultType="contTmplVO">
		/* com.opennote.standard.mapper.usersupport.contTmplMngMapper.fvrtSelectList */
		SELECT B.TMPL_SERNO								tmplSerno
		  	 , B.TMPL_EXPL								tmplExpl          
		   	 , B.EDITR_CONT								editrCont
		  	 , B.PRVW_FILE_SERNO						prvwFileSerno	   	 
		   	 , FNC_CODE_NM(B.TMPL_CL)					tmplCl
		   	 , FNC_CODE_NM(B.TMPL_TP)					tmplTp
		  	 , DATE_FORMAT(B.REG_DT, '%Y.%m.%d')		regDt    
		   	 , A.FVRT_SERNO								fvrtSerno  
	      FROM T_CONT_TMPL_FVRT_MNG A
   	 LEFT JOIN T_CONT_TMPL_MNG B
   			ON A.TMPL_SERNO = B.TMPL_SERNO
   		   AND B.USE_YN = 'Y'
		<where>  
		 	   A.REGR_SERNO = #{loginSerno}
		   AND A.TMPL_SERNO IS NOT NULL
		   AND B.TMPL_SERNO	IS NOT NULL
	     	   <include refid="Where"/>
		   AND A.USE_YN = 'Y'
		</where>
	  ORDER BY A.TMPL_SERNO DESC 
		 LIMIT #{firstRecordIndex} , #{recordCountPerPage}	
	</select>
	
	
	<!-- 컨텐츠 즐겨찾기 건수 조회-->
	<select id="fvrtSelectCount" parameterType="contTmplVO" resultType="contTmplVO">
		/* com.opennote.standard.mapper.usersupport.contTmplMngMapper.fvrtSelectCount */
		SELECT COUNT(1) tmplCnt
		  FROM T_CONT_TMPL_FVRT_MNG A
	 LEFT JOIN T_CONT_TMPL_MNG B
   			ON A.TMPL_SERNO = B.TMPL_SERNO
   		   AND B.USE_YN = 'Y'
		 <where> 
		 	   A.REGR_SERNO = #{loginSerno}
		   AND A.TMPL_SERNO IS NOT NULL
		   AND B.TMPL_SERNO	IS NOT NULL
		       <include refid="Where"/>
		    AND A.USE_YN = 'Y'
		 </where>
	</select>
	
	<!-- 컨텐츠 즐겨찾기 등록 -->
	<insert id="insertFvrtContents" parameterType="contTmplVO">
		/* com.opennote.standard.mapper.usersupport.contTmplMngMapper.insertFvrtContents */
		INSERT INTO T_CONT_TMPL_FVRT_MNG (
			        TMPL_SERNO
		          , REGR_SERNO
		          , REG_DT
		          ) VALUES (
			        #{tmplSerno}
		          , #{loginSerno}
		          , NOW()
		          )
	</insert>
	
	<!-- 컨텐츠 즐겨찾기 삭제 -->
	<update id="deleteFvrtContents" parameterType="contTmplVO">
		/* com.opennote.standard.mapper.usersupport.contTmplMngMapper.deleteFvrtContents */
		UPDATE T_CONT_TMPL_FVRT_MNG
		   SET UPDR_SERNO		= #{loginSerno}    
			 , UPD_DT			= NOW()     
			 , USE_YN 			= 'N'
	     <where> 
		       TMPL_SERNO 	    = #{tmplSerno}
		   AND REGR_SERNO  		= #{loginSerno}
		   AND USE_YN = 'Y'
		 </where> 
	</update>
	
	<!-- 컨텐츠 게시글 본인글 여부 -->
	<select id="regrCheck" parameterType="contTmplVO" resultType="contTmplVO">
		/* com.opennote.standard.mapper.usersupport.contTmplMngMapper.regrCheck */
		SELECT CASE WHEN REGR_SERNO = #{loginSerno} THEN 1
					ELSE 0
			   END isRegrCheck
		  FROM T_CONT_TMPL_MNG 
		 <where> 
		 	    TMPL_SERNO = #{tmplSerno}
		   AND USE_YN = 'Y'
		 </where>
	</select>
	
	<!-- 컨텐츠 업로드파일  본인 여부 -->
	<select id="fileRegrCheck" parameterType="contTmplVO" resultType="boolean">
		/* com.opennote.standard.mapper.usersupport.contTmplMngMapper.fileRegrCheck */
		SELECT CASE WHEN REGR_SERNO = #{loginSerno} THEN 1
					ELSE 0
			   END isFileRegrCheck
		  FROM T_CONT_TMPL_FILE_MNG 
		 <where> 
		 	    TMPL_FILE_SERNO = #{tmplFileSerno}
		   AND DEL_YN = 'N'
		 LIMIT 1
		 </where>
	</select>
	
	<!-- 컨텐츠 첫번째 파일 등록 -->
	<insert id="insertContTmplFileFirst" parameterType="contTmplVO" useGeneratedKeys="true" keyProperty="tmplFileSerno" keyColumn="TMPL_FILE_SERNO">
		/* com.opennote.standard.mapper.usersupport.contTmplMngMapper.insertContTmplFileFirst */
			INSERT INTO T_CONT_TMPL_FILE_MNG (
				  TMPL_FILE_SERNO
				, FILE_SEQO
				, RL_FILE_NM
				, FILE_EXTN_NM
				, FILE_SZ_VAL
				, FILE_TP_NM
				, IMG_WDTH_SZ_VAL
				, IMG_HGHT_SZ_VAL
				, REGR_SERNO				
				, FILE_BYTE
			)
			VALUES (
				  #{tmplFileSerno}				
				, 0
				, #{rlFileNm}
				, #{fileExtnNm}
				, #{fileSzVal}
				, #{fileTpNm}
				, #{imgWdthSzVal}
				, #{imgHghtSzVal}
				, #{loginSerno}
				, #{fileByte}	
			)
	</insert>
	
	<!-- 컨텐츠 파일 목록 등록 -->
	<insert id="insertContTmplFileList" parameterType="contTmplVO">
		/* com.opennote.standard.mapper.usersupport.contTmplMngMapper.insertContTmplFileList */
			<selectKey resultType="String" keyProperty="fileSeqo" order="BEFORE">
		        SELECT IFNULL(MAX(FILE_SEQO)+1,0) fileSeqo FROM T_CONT_TMPL_FILE_MNG WHERE TMPL_FILE_SERNO = #{tmplFileSerno}
		    </selectKey>
			INSERT INTO T_CONT_TMPL_FILE_MNG (
				  TMPl_FILE_SERNO
				, FILE_SEQO
				, RL_FILE_NM
				, FILE_EXTN_NM
				, FILE_SZ_VAL
				, FILE_TP_NM
				, IMG_WDTH_SZ_VAL
				, IMG_HGHT_SZ_VAL
				, REGR_SERNO
				, FILE_BYTE
			)
			VALUES (
				  #{tmplFileSerno}
				, #{fileSeqo}
				, #{rlFileNm}
				, #{fileExtnNm}
				, #{fileSzVal}
				, #{fileTpNm}
				, #{imgWdthSzVal}
				, #{imgHghtSzVal}
				, #{loginSerno}
				, #{fileByte}	
			)
	</insert>
	
	<!-- 컨텐츠 파일 목록 조회 -->
	<select id="selectContTmplFileList" parameterType="contTmplVO" resultType="contTmplVO">
		/* com.opennote.standard.mapper.usersupport.contTmplMngMapper.selectCntntFileList */
		SELECT TMPL_FILE_SERNO												tmplFileSerno
			 , FILE_SEQO													fileSeqo
			 , RL_FILE_NM													rlFileNm
			 , TRUNCATE(CEILING(FILE_SZ_VAL/(1024 * 1024 * 100))/100, 2)	fileSzVal
			 , DATE_FORMAT(REG_DT, '%Y.%m.%d')								regDt
	      FROM T_CONT_TMPL_FILE_MNG
		<where>
			   DEL_YN = 'N'
		   AND TMPL_FILE_SERNO = #{tmplFileSerno}
		</where>
     ORDER BY FILE_SEQO ASC
	</select>
	
	<!-- 컨텐츠 파일 상세 조회 -->
	<select id="selectContTmplFileContents" parameterType="contTmplVO" resultType="contTmplVO">
		/* com.opennote.standard.mapper.usersupport.contTmplMngMapper.selectFileInfo */
		SELECT
			   TMPL_FILE_SERNO	tmplFileSerno
			 , FILE_SEQO		fileSeqo
			 , RL_FILE_NM		rlFileNm
			 , FILE_TP_NM		fileTpNm
			 , FILE_BYTE		fileByte
	      FROM T_CONT_TMPL_FILE_MNG
		<where>
			   DEL_YN = 'N'
		   AND TMPL_FILE_SERNO = #{tmplFileSerno}
		   AND FILE_SEQO = #{fileSeqo}
		</where>
	</select>
	
	<!-- 컨텐츠 파일 삭제 -->
	<update id="deleteContTmplFile" parameterType="contTmplVO">
		/* com.opennote.standard.mapper.usersupport.contTmplMngMapper.deleteCntntFile */
		UPDATE T_CONT_TMPL_FILE_MNG
		   SET DEL_YN = 'Y'
		<where>
			   DEL_YN = 'N' 
		   AND TMPL_FILE_SERNO = #{tmplFileSerno}
		   AND FILE_SEQO IN
			<foreach item="item" collection="tempArr" index="idx" open="(" separator="," close=")">
			   #{item}
			</foreach> 
		</where>
	</update>
	
	<!-- 컨텐츠 파일 수정 -->
	<update id="updateContTmplFile" parameterType="contTmplVO">
		/* com.opennote.standard.mapper.usersupport.contTmplMngMapper.updateCntntFile */
		UPDATE T_CONT_TMPL_FILE_MNG
		   SET FILE_BYTE = #{fileByte}
		<where>
			   DEL_YN = 'N'
		   AND TMPL_FILE_SERNO = #{tmplFileSerno}
		   AND FILE_SEQO = #{fileSeqo}
		</where>
	</update>
	
	<!-- 파일 일련번호 생성 -->
	<select id="getTmplFileSerno" resultType="contTmplVO">
		/* com.opennote.standard.mapper.usersupport.contTmplMngMapper.getTmplFileSerno */
		SELECT IFNULL(MAX(CAST(TMPL_FILE_SERNO  AS UNSIGNED)),0)+1 tmplFileSerno
		  FROM T_CONT_TMPL_FILE_MNG
	</select>
</mapper>