<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.opennote.standard.component.itsm.mapper.ItsmSlaItmScrngMapper">


    <!-- 목록 -->
    <select id="selectList" parameterType="itsmSlaDefVO" resultType="itsmSlaDefVO">
        /* ItsmSlaItmScrngMapper.selectList */
        SELECT A.SCRNG_SN							    scrngSn
             , A.SVRNG_SUB_SN						    svrngSubSn
             , A.ITM_CN								    itmCn
             , A.ITM_SCRNG							    itmScrng
             , A.IDXI_SE_CD							    idxiSeCd
             , ITSM_FNC_CODE_NM(A.IDXI_SE_CD)		    idxiSeNm
             , DATE_FORMAT(A.BGNG_YM, '%Y.%m')		    bgngYm
             , A.ITM_SEQO                    		    itmSeqo
             , A.ITM_SEQO                    		    itmSeqo
             , A.ITM_SEQO                    		    itmSeqo
             , IFNULL(A.MSRMT_CNT, 0)                   msrmtCnt
             , IFNULL(A.MSRMT_TRGT_CNT, 0)              msrmtTrgtCnt
             , FNC_USER_NM(A.RGTR_SN)  				    rgtrNm
             , FNC_USER_NM(A.MDFR_SN)  				    mdfrNm
             , DATE_FORMAT(A.REG_DT, '%Y.%m.%d')        regDt
             , DATE_FORMAT(A.MDFCN_DT, '%Y.%m.%d')      mdfcnDt
          FROM ITSM_SLA_ITM_SCRNG_SUB A
          LEFT OUTER JOIN ITSM_SLA_ITM_SCRNG B
            ON A.SCRNG_SN = B.SCRNG_SN
         WHERE A.USE_YN = 'Y'
           AND B.SVC_SN = #{svcSn}
           AND DATE_FORMAT(A.BGNG_YM, '%Y.%m') = LEFT(#{searchbgngYm},7)
         ORDER BY A.ITM_SEQO
    </select>

    <!-- 생성 -->
    <update id="insertContents" parameterType="itsmSlaDefVO">
        /* ItsmSlaItmScrngMapper.insertContents */
        <selectKey resultType="String" keyProperty="scrngSn" order="AFTER">
            SELECT LAST_INSERT_ID()
        </selectKey>
        INSERT INTO ITSM_SLA_ITM_SCRNG
             ( REG_DT
             , RGTR_SN
             , SVC_SN
             )
        VALUES
            ( NOW()
            , #{loginSerno}
            , #{svcSn}
            )
    </update>

    <update id="mergeContents" parameterType="itsmSlaDefVO">
        /* ItsmSlaItmScrngMapper.mergeContents */
        INSERT INTO ITSM_SLA_ITM_SCRNG_SUB
             ( SCRNG_SN
             , SVRNG_SUB_SN
             , ITM_CN
             , ITM_SCRNG
             , IDXI_SE_CD
             , BGNG_YM
             , ITM_SEQO
             , REG_DT
             , RGTR_SN
             )
        VALUES
             ( #{scrngSn}
             , IF(#{svrngSubSn} = '', NULL, #{svrngSubSn})
             , #{itmCn}
             , #{itmScrng}
             , #{idxiSeCd}
             , IF(#{bgngYm} = '', NULL, CONCAT(LEFT(#{bgngYm}, 7),'.01 00:00:00'))
             , #{itmSeqo}
             , NOW()
             , #{loginSerno}
             )
            ON DUPLICATE KEY UPDATE
               SCRNG_SN			= #{scrngSn}
             , SVRNG_SUB_SN		= #{svrngSubSn}
             , ITM_CN			= #{itmCn}
             , ITM_SCRNG		= #{itmScrng}
             , IDXI_SE_CD		= #{idxiSeCd}
             , BGNG_YM			= IF(#{bgngYm} = '', NULL, CONCAT(LEFT(#{bgngYm}, 7),'.01 00:00:00'))
             , ITM_SEQO			= #{itmSeqo}
             , MDFCN_DT			= NOW()
             , MDFR_SN			= #{loginSerno}
             , USE_YN 	        = 'Y'
    </update>

    <update id="updateItmContent" parameterType="itsmSlaDefVO">
        /* ItsmSlaItmScrngMapper.updateItmContent */
        UPDATE ITSM_SLA_ITM_SCRNG_SUB
           SET ITM_CN			= #{itmCn}
             , ITM_SCRNG		= #{itmScrng}
             , IDXI_SE_CD		= #{idxiSeCd}
             , BGNG_YM			= IF(#{bgngYm} = '', NULL, CONCAT(LEFT(#{bgngYm}, 7),'.01 00:00:00'))
             , MDFCN_DT			= NOW()
             , MDFR_SN			= #{loginSerno}
         WHERE SVRNG_SUB_SN		= #{svrngSubSn}

    </update>

    <update id="updateMsrmtContents" parameterType="itsmSlaDefVO">
        /* ItsmSlaItmScrngMapper.updateMsrmtContents */
        UPDATE ITSM_SLA_ITM_SCRNG_SUB
           SET MSRMT_CNT			= #{msrmtCnt}
             , MSRMT_TRGT_CNT		= #{msrmtTrgtCnt}
         WHERE SVRNG_SUB_SN		    = #{svrngSubSn}

    </update>

    <!-- 삭제 -->
    <update id="deleteItmContents" parameterType="itsmSlaDefVO">
        /* ItsmSlaItmScrngMapper.deleteItmContents */
        UPDATE ITSM_SLA_ITM_SCRNG_SUB
           SET USE_YN 	  = 'N'
         WHERE SCRNG_SN   = #{scrngSn}
    </update>


    <select id="selectItmContents" parameterType="itsmSlaRptVO" resultType="itsmSlaDefVO">
        /* ItsmSlaItmScrngMapper.selectItmContents */
        SELECT A.SCRNG_SN		scrngSn
             , COUNT(1) 		schEtc03
          FROM ITSM_SLA_ITM_SCRNG A
          LEFT OUTER JOIN ITSM_SLA_ITM_SCRNG_SUB B
            ON A.SCRNG_SN = B.SCRNG_SN
           AND B.USE_YN = 'Y'
         WHERE A.USE_YN = 'Y'
           AND A.SVC_SN = #{svcSn}
           AND DATE_FORMAT(B.BGNG_YM, '%Y.%m') = DATE_FORMAT(#{bgngYm}, '%Y.%m')
         GROUP BY A.SCRNG_SN
    </select>


    <select id="reportMaking" parameterType="itsmSlaRptVO" resultType="itsmSlaDefVO">
        /* ItsmSlaItmScrngMapper.reportMaking */
        SELECT B.SCRNG_SN							         scrngSn
             , B.SVRNG_SUB_SN						         svrngSubSn
             , B.ITM_CN								         itmCn
             , B.ITM_SCRNG							         itmScrng
             , B.IDXI_SE_CD							         idxiSeCd
             , ITSM_FNC_CODE_NM(B.IDXI_SE_CD)				 idxiSeNm
             , DATE_FORMAT(B.BGNG_YM, '%Y.%m')		         bgngYm
             , DATE_FORMAT(B.BGNG_YM, '%Y.%m.01')			 schEtc01
             , DATE_FORMAT(LAST_DAY(B.BGNG_YM), '%Y.%m.%d')	 schEtc02
             , B.ITM_SEQO                    		         itmSeqo
             , B.ITM_SEQO                    		         itmSeqo
             , B.ITM_SEQO                    		         itmSeqo
             , IFNULL(B.MSRMT_CNT, 0)                        msrmtCnt
             , IFNULL(B.MSRMT_TRGT_CNT, 0)                   msrmtTrgtCnt
             , FNC_USER_NM(B.RGTR_SN)  				         rgtrNm
             , FNC_USER_NM(B.MDFR_SN)  				         mdfrNm
             , DATE_FORMAT(B.REG_DT, '%Y.%m.%d')             regDt
             , DATE_FORMAT(B.MDFCN_DT, '%Y.%m.%d')           mdfcnDt
          FROM ITSM_SLA_ITM_SCRNG A
          LEFT OUTER JOIN ITSM_SLA_ITM_SCRNG_SUB B
            ON A.SCRNG_SN = B.SCRNG_SN
           AND B.USE_YN = 'Y'
         WHERE A.USE_YN = 'Y'
           AND A.SVC_SN = #{svcSn}
           AND DATE_FORMAT(B.BGNG_YM, '%Y.%m') = DATE_FORMAT(#{bgngYm}, '%Y.%m')
         ORDER BY B.ITM_SEQO
    </select>

</mapper>