<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.opennote.standard.component.itsm.mapper.ItsmMenuAuthMngMapper">

    <sql id="Where">
        <if test="searchKeyword !=null and searchKeyword !=''">
            <if test="searchCondition ==null or searchCondition ==''">
                AND (UPPER(GRP_AUTH_ID) LIKE CONCAT('%',IFNULL(UPPER(#{searchKeyword}), ''),'%') OR UPPER(GRP_AUTH_NM) LIKE CONCAT('%',IFNULL(UPPER(#{searchKeyword}), ''),'%'))
            </if>
            <if test="searchCondition !=null and searchCondition !='' and searchCondition ==1">
                AND UPPER(GRP_AUTH_ID) LIKE CONCAT('%',IFNULL(UPPER(#{searchKeyword}), ''),'%')
            </if>
            <if test="searchCondition !=null and searchCondition !='' and searchCondition ==2">
                AND UPPER(GRP_AUTH_NM) LIKE CONCAT('%',IFNULL(UPPER(#{searchKeyword}), ''),'%')
            </if>
        </if>
    </sql>

    <select id="selectContents" parameterType="itsmAuthVO" resultType="itsmAuthVO">
        /* ItsmMenuAuthMngMapper.selectContents */
		<![CDATA[
        SELECT GRP_AUTH_SERNO                           grpAuthSerno
             , GRP_AUTH_ID                              grpAuthId
             , GRP_AUTH_NM                              grpAuthNm
             , DATE_FORMAT(REG_DT,'%Y.%m.%d')           regDt
             , REGR_SERNO 	                            regId
             , USE_YN 	                                useYn
             , GRP_AUTH_EXPL                            grpAuthrtExpl
          FROM T_GRP_AUTH_MNG
         WHERE GRP_AUTH_SERNO = #{grpAuthSerno}
        ]]>
    </select>

    <!-- 전체 메뉴 및 권한 조회 -->
    <select id="selectMenuList" parameterType="itsmAuthVO" resultType="itsmAuthVO">
        /* ItsmMenuAuthMngMapper.selectMenuList */
        SELECT A.MENU_SERNO 																				menuSerno
             , A.UPR_MENU_CD 																				uprMenuCd
             , A.MENU_LVL 																					menuLvl
             , A.MENU_SEQO 																					menuSeqo
             , A.MENU_NM 																					menuNm
             , A.MENU_CD 																					menuCd
             , CASE WHEN B.MENU_CD IS NULL THEN 'N' ELSE 'Y' END											authExst
             , NVL(B.WRT_AUTH_YN, 'R')																		wrtAuthYn
             , (SELECT EXISTS (SELECT * FROM ITSM_MENU WHERE UPR_MENU_CD = A.MENU_CD AND USE_YN = 'Y'))	isLeaf
        FROM ITSM_MENU A
                 LEFT JOIN ITSM_MENU_AUTH_MNG B
                           ON A.MENU_CD  		 = B.MENU_CD
                               AND B.GRP_AUTH_ID 	 = #{grpAuthId	}
        WHERE A.USE_YN 		 = 'Y'
          AND A.EXPSR_YN 	 	 = 'Y'
        ORDER BY A.MENU_SEQO
    </select>

    <select id="selectList" parameterType="itsmAuthVO" resultType="itsmAuthVO">
        /* ItsmMenuAuthMngMapper.selectList */
        SELECT GRP_AUTH_SERNO                           grpAuthSerno
             , GRP_AUTH_ID                              grpAuthId
             , GRP_AUTH_NM                              grpAuthNm
             , DATE_FORMAT(REG_DT,'%Y.%m.%d')           regDt
             , REGR_SERNO                               regrSerno
             , USE_YN                                   useYn
             , GRP_AUTH_EXPL                            grpAuthrtExpl
          FROM T_GRP_AUTH_MNG
          <where>
              <include refid="Where"/>
              AND DEL_YN = 'N'
          </where>
        ORDER BY GRP_AUTH_SERNO DESC
        LIMIT #{firstRecordIndex},#{lastRecordIndex}
    </select>

    <select id="selectAllList" parameterType="itsmAuthVO" resultType="itsmAuthVO">
        /* ItsmMenuAuthMngMapper.selectAllList */
        SELECT GRP_AUTH_SERNO                           grpAuthSerno
             , GRP_AUTH_ID                              grpAuthId
             , GRP_AUTH_NM                              grpAuthNm
             , DATE_FORMAT(REG_DT,'%Y.%m.%d')           regDt
             , REGR_SERNO                               regrSerno
             , USE_YN                                   useYn
             , GRP_AUTH_EXPL                            grpAuthExpl
          FROM T_GRP_AUTH_MNG
         WHERE DEL_YN = 'N'
           AND USE_YN = 'Y'
    </select>

    <select id="selectCount" parameterType="itsmAuthVO" resultType="int">
        /* ItsmMenuAuthMngMapper.selectCount */
			SELECT COUNT(GRP_AUTH_SERNO)    cnt
			  FROM T_GRP_AUTH_MNG
        <where>
            <include refid="Where"/>
            AND DEL_YN = 'N'
        </where>
    </select>

    <select id="overlapSelectCount" parameterType="itsmAuthVO" resultType="int">
		<![CDATA[
        /* ItsmMenuAuthMngMapper.overlapSelectCount */
        SELECT COUNT(GRP_AUTH_SERNO)    cnt
          FROM T_GRP_AUTH_MNG
         WHERE GRP_AUTH_ID = #{grpAuthId}
        ]]>
	</select>

    <delete id="authDeleteContents" parameterType="itsmAuthVO">
        /* ItsmMenuAuthMngMapper.authDeleteContents */
		<![CDATA[
        DELETE FROM ITSM_MENU_AUTH_MNG
         WHERE GRP_AUTH_ID = #{grpAuthId}
        ]]>
    </delete>

    <!-- 게시판 별 권한 등록 -->
    <insert id="authInsertContents" parameterType="itsmAuthVO">
        /* ItsmMenuAuthMngMapper.authInsertContents */
		<![CDATA[
        INSERT INTO ITSM_MENU_AUTH_MNG
             ( GRP_AUTH_ID
             , MENU_CD
             , WRT_AUTH_YN
             , REGR_SERNO
             )
        VALUES
             ( #{grpAuthId}
             , #{menuCd}
             , #{wrtAuthYn}
             , #{loginSerno}
             )
        ]]>
    </insert>

    <!-- itsm 관리자 권한 취득 -->
    <select id="getItsmAuthList" parameterType="userVO" resultType="java.lang.String">
        /* ItsmMenuAuthMngMapper.getItsmAuthList */
        SELECT MENU_CD
          FROM ITSM_MENU_AUTH_MNG
         WHERE GRP_AUTH_ID = #{grpAuthId}
    </select>

    <!-- itsm 관리자 작성 권한 취득 -->
    <select id="getWrtItsmAuthList" parameterType="userVO" resultType="itsmAuthVO">
        /* ItsmMenuAuthMngMapper.getWrtItsmAuthList */
        SELECT MENU_CD				menuCd
             , WRT_AUTH_YN		    wrtAuthYn
          FROM ITSM_MENU_AUTH_MNG
         WHERE GRP_AUTH_ID = #{grpAuthId}
    </select>

    <!-- 본인글 여부 -->
    <select id="regrCheck" parameterType="itsmAuthVO" resultType="boolean">
        /* ItsmMenuAuthMngMapper.regrCheck */
        SELECT CASE WHEN REGR_SERNO = #{loginSerno} THEN 1 ELSE 0 END
          FROM T_GRP_AUTH_MNG
         WHERE GRP_AUTH_SERNO = #{grpAuthSerno}
    </select>


    <!-- 특정 메뉴를 권한으로 가지고 있는 그룹 ID 찾기 -->
    <select id="getGrpAuthIdList" parameterType="itsmAuthVO" resultType="itsmAuthVO">
        /* ItsmMenuAuthMngMapper.getGrpAuthIdList */
        SELECT GRP_AUTH_ID grpAuthId
        FROM ITSM_MENU_AUTH_MNG
        WHERE MENU_CD = #{menuCd}
          AND USE_YN = 'Y'
    </select>
    <!-- 메뉴 권한 삭제 -->
    <delete id="menuAuthDeleteContents" parameterType="java.lang.String">
        /* ItsmMenuAuthMngMapper.menuAuthDeleteContents */
        DELETE FROM ITSM_MENU_AUTH_MNG
        WHERE MENU_CD = #{menuCd}
    </delete>
</mapper>