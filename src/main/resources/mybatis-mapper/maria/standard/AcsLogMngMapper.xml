<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.standard.mapper.basic.AcsLogMngMapper">

    <!-- 검색 조건 -->
    <sql id="Where">
        <if test='searchKeyword !=null and searchKeyword !=""'>
            <if test='searchCondition ==null or searchCondition == ""'>
                AND (
                       UPPER(FNC_USER_NM(REGR_SERNO)) LIKE CONCAT('%',UPPER(#{searchKeyword}),'%')
                    OR UPPER(ACS_ID) LIKE CONCAT('%',UPPER(#{searchKeyword}),'%')
                )
            </if>
            <if test='searchCondition !=null and searchCondition !="" and searchCondition==1'>
                AND UPPER(ACS_ID) LIKE CONCAT('%',UPPER(#{searchKeyword}),'%')
            </if>
            <if test='searchCondition !=null and searchCondition !="" and searchCondition==2'>
                AND UPPER(FNC_USER_NM(REGR_SERNO)) LIKE CONCAT('%',UPPER(#{searchKeyword}),'%')
            </if>
        </if>
        <!-- 기간 -->
        <if test='searchStartDate !=null and searchStartDate !="" and searchEndDate !=null and searchEndDate !="" '>
            AND REG_DT <![CDATA[>=]]> STR_TO_DATE(#{searchStartDate}, '%Y.%m.%d')
            AND REG_DT <![CDATA[<=]]> DATE_ADD(STR_TO_DATE(#{searchEndDate}, '%Y.%m.%d'), INTERVAL 86399 SECOND)
        </if>
        <!-- 권한영역 -->
        <if test='schEtc00 !=null and schEtc00 !=""'>
            AND AUTH_AREA_CD = #{schEtc00}
        </if>
        <!-- 탭 메뉴 -->
        <if test='schEtc01 =="02"'>
            AND (HOUR(REG_DT) <![CDATA[<]]> 7 OR HOUR(REG_DT) <![CDATA[>=]]> 18)
        </if>
        <if test='schEtc01 =="04"'>
            AND (IP_ERR_YN = 'Y' OR LGIN_YN = 'Y')
        </if>
    </sql>

	<!-- 접속 로그 등록 -->
	<insert id="insertContents" parameterType="acsVO">
        /* com.standard.mapper.basic.AcsLogMngMapper.insertContents */
        INSERT INTO T_ACS_LOG_MNG(
        	   ACS_LOG_IP_ADDR
             , REGR_SERNO
             , IP_ERR_YN
             , LGIN_YN
             , LGIN_LMT_YN
             , ACS_ID
             , AUTH_AREA_CD
        ) 
        VALUES (
        	   #{acsLogIpAddr}
             , #{regrSerno}
             , CASE WHEN #{ipErrYn} IS NULL OR #{ipErrYn} = '' THEN 'N'
                    ELSE #{ipErrYn}
                END
             , CASE WHEN #{lginYn} IS NULL OR #{lginYn} = '' THEN 'N'
                    ELSE #{lginYn}
                END
             , CASE WHEN #{lginLmtYn} IS NULL OR #{lginLmtYn} = '' THEN 'N'
                    ELSE #{lginLmtYn}
                END
             , #{acsId}
             , #{authAreaCd}
        )
    </insert>

    <!-- 접속 로그 건수 조회 -->
    <select id="selectCount" parameterType="acsVO" resultType="acsVO">
        /* com.standard.mapper.basic.AcsLogMngMapper.selectCount */
        SELECT COUNT(1) acsLogCnt
          FROM T_ACS_LOG_MNG A
        <where>
            <include refid="Where"/>
        </where>
    </select>

    <!-- 접속 로그 목록 조회 -->
    <select id="selectList" parameterType="acsVO" resultType="acsVO">
        /* com.standard.mapper.basic.AcsLogMngMapper.selectList */
        SELECT ACS_LOG_SERNO                                acsLogSerno
             , ACS_LOG_IP_ADDR                              acsLogIpAddr
             , REGR_SERNO                                   regrSerno
             , FNC_USER_NM(REGR_SERNO)                      regrNm
             , DATE_FORMAT(REG_DT, '%Y.%m.%d %H:%i')        regDt
             , IP_ERR_YN                                    ipErrYn
             , LGIN_YN                                      lginYn
             , LGIN_LMT_YN                                  lginLmtYn
             , ACS_ID                                       acsId
             , AUTH_AREA_CD                                 authAreaCd
          FROM T_ACS_LOG_MNG
        <where>
            <include refid="Where"/>
        </where>
      ORDER BY ACS_LOG_SERNO DESC
         LIMIT #{firstRecordIndex} , #{recordCountPerPage}
    </select>

    <!-- 과다접속 로그 건수 조회 -->
    <select id="tmchSelectCount" parameterType="acsVO" resultType="acsVO">
        /* com.standard.mapper.basic.AcsLogMngMapper.tmchSelectCount */
        SELECT COUNT(1) logCnt
          FROM (SELECT A.ACS_LOG_SERNO
                  FROM T_ACS_LOG_MNG A
                <where>
                    <include refid="Where"/>
                </where>
              GROUP BY REGR_SERNO, ACS_LOG_IP_ADDR, REG_DT, AUTH_AREA_CD
                HAVING COUNT(REGR_SERNO) >= 5
                ) B
    </select>

    <!-- 과다접속 로그 목록 조회 -->
    <select id="tmchSelectList" parameterType="acsVO" resultType="acsVO">
        /* com.standard.mapper.basic.AcsLogMngMapper.tmchSelectList */
        SELECT B.*
          FROM (SELECT ACS_LOG_IP_ADDR                                  acsLogIpAddr
                     , REGR_SERNO                                       regrSerno
                     , FNC_USER_NM(REGR_SERNO)                          regrNm
                     , MAX(DATE_FORMAT(REG_DT, '%Y.%m.%d %H:%i:%s'))    regDt
                     , COUNT(REGR_SERNO)                                logCnt
                     , ACS_ID                                           acsId
                     , AUTH_AREA_CD                                     authAreaCd
                  FROM T_ACS_LOG_MNG
                <where>
                    <include refid="Where"/>
                </where>
              GROUP BY REGR_SERNO, ACS_LOG_IP_ADDR, REG_DT, AUTH_AREA_CD
                HAVING COUNT(REGR_SERNO) >= 5
              ORDER BY REG_DT DESC
                ) B
         LIMIT #{firstRecordIndex} , #{recordCountPerPage}
    </select>

    <!-- 시간별 접속수(현재날짜) -->
    <select id="selectAcsTime" resultType="CommonMap">
        /* com.standard.mapper.basic.AcsLogMngMapper.selectAcsTime */
        SELECT DATE_FORMAT(REG_DT, '%H:00')     regDt
             , COUNT(1)                         cnt
        FROM T_ACS_LOG_MNG
        WHERE REG_DT <![CDATA[>=]]> CURDATE()
        GROUP BY DATE_FORMAT(REG_DT, '%H')
        ORDER BY regDt
    </select>

</mapper>