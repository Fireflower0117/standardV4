<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.opennote.standard.mapper.basic.UserIpMngMapper">

	<!-- 접근IP 목록 조회 -->
	<select id="selectList" parameterType="userVO" resultType="userVO">
		/* com.opennote.standard.mapper.basic.UserIpMngMapper.selectList */
		SELECT IP_SERNO 													ipSerno
			 , USER_SERNO													userSerno
			 , STRT_IP 														strtIp
			 , END_IP 														endIp
			 , BAWD_YN 														bawdYn
			 , SEQO 														seqo
			 , SUBSTRING_INDEX(STRT_IP, '.', 1) 							strtIp1
			 , SUBSTRING_INDEX(SUBSTRING_INDEX(STRT_IP, '.', 2), '.', -1)	strtIp2
			 , SUBSTRING_INDEX(SUBSTRING_INDEX(STRT_IP, '.', 3), '.', -1) 	strtIp3
			 , SUBSTRING_INDEX(STRT_IP, '.', -1) 							strtIp4
			 , SUBSTRING_INDEX(END_IP, '.', 1) 								endIp1
			 , SUBSTRING_INDEX(SUBSTRING_INDEX(END_IP, '.', 2), '.', -1) 	endIp2
			 , SUBSTRING_INDEX(SUBSTRING_INDEX(END_IP, '.', 3), '.', -1) 	endIp3
			 , SUBSTRING_INDEX(END_IP, '.', -1) 							endIp4
		  FROM T_USER_IP_MNG
		 WHERE USER_SERNO = ${userSerno}
		   AND USE_YN = 'Y'
	  ORDER BY SEQO ASC
	</select>
	
	<!-- 접근가능 IP대역 여부 체크 -->
	<select id="userIpBrkYn" parameterType="userIpVO" resultType="userIpVO">
		/* com.opennote.standard.mapper.basic.UserIpMngMapper.userIpBrkYn */
		SELECT CASE WHEN COUNT(B.IP_SERNO) = 0 
						 THEN 0
					WHEN CAST(REPLACE(#{schEtc00}, '.', '') AS UNSIGNED) BETWEEN CAST(REPLACE(B.STRT_IP, '.', '') AS UNSIGNED) AND CAST(REPLACE(B.END_IP, '.', '') AS UNSIGNED)
	  					 THEN 1
					ELSE 0
			   END AS ipBrkYn
	 	  FROM T_USER_MNG A
     LEFT JOIN T_USER_IP_MNG B 
     		ON A.USER_SERNO = B.USER_SERNO 
     	   AND B.USE_YN = 'Y'
		 WHERE A.USER_SERNO = #{userSerno}
	</select>

	<insert id="insertIpContents" parameterType="userVO">
		/* com.opennote.standard.mapper.basic.UserIpMngMapper.insertIpContents */
		INSERT INTO T_USER_IP_MNG
		     ( USER_SERNO
			 , STRT_IP
			 , END_IP
			 , BAWD_YN
			 , SEQO
			 , REG_DT
			 , REGR_SERNO
			 ) VALUES
			 ( #{userSerno}
			 , #{strtIp}
	<choose>
		<when test='bawdYn == "N"'>
			 , NULL
		</when>
		<otherwise>
			 , #{endIp}
		</otherwise>
	</choose>
			 , #{bawdYn}
			 , #{seqo}
			 , NOW()
			 , #{loginSerno}
		)
	</insert>

	<!-- IP 전체삭제 -->
	<delete id="deleteIpContents" parameterType="userVO">
		/* com.opennote.standard.mapper.basic.UserIpMngMapper.deleteIpContents */
		DELETE FROM T_USER_IP_MNG
		 WHERE USER_SERNO = #{userSerno}
	</delete>
	
</mapper>